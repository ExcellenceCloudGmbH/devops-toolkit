name: Semgrep reusable scan

on:
  workflow_call:
    secrets:
      SEMGREP_APP_TOKEN:
        required: true
      BOT_PAT:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    env:
      SEMGREP_CLOUD_URL: https://semgrep.dev/orgs/excellence-cloud/projects

    steps:
      - name: Checkout PR or branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Install Semgrep CLI and jq
        run: |
          pip install semgrep
          sudo apt-get -qq update
          sudo apt-get -y install jq

      - name: Run Semgrep and save JSON
        id: run-semgrep
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          semgrep ci --json > semgrep-results.json || true
          COUNT=$(jq '.results | length' semgrep-results.json)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"


      - name: Comment on PR with Semgrep findings
        if: github.event_name == 'pull_request' && steps.run-semgrep.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('semgrep-results.json','utf8'));
            if (!results.results?.length || !context.issue?.number) return;

            const uniq = [...new Map(results.results.map(i => [
              `${i.check_id}:${i.path}:${i.start.line}`, i])).values()];

            let body = `**Semgrep found ${uniq.length} unique issue(s):**\n\n`;
            for (const i of uniq) {
              const msg = i.message || i.extra?.message || 'no description';
              body += `- \`${i.path}:${i.start.line}\` **${i.check_id}** – ${msg}\n`;
            }
            body += `\n---\n[View full results on Semgrep Cloud](${process.env.SEMGREP_CLOUD_URL})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Comment on commit with Semgrep findings
        if: github.event_name != 'pull_request' && steps.run-semgrep.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_PAT }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('semgrep-results.json','utf8'));
            if (!results.results?.length) {
              console.log("No findings");
              return;
            }

            const uniq = [...new Map(results.results.map(i => [
              `${i.check_id}:${i.path}:${i.start.line}`, i])).values()];

            let body = `**Semgrep found ${uniq.length} issue(s):**\n\n`;
            for (const i of uniq) {
              const msg = i.message || i.extra?.message || 'no description';
              body += `- \`${i.path}:${i.start.line}\` **${i.check_id}** – ${msg}\n`;
            }
            body += `\n[Full report](${process.env.SEMGREP_CLOUD_URL})`;

            const sha = context.payload?.after || context.sha;
            console.log("DEBUG: Using commit SHA:", sha);
            console.log("DEBUG: Repo:", context.repo.owner, "/", context.repo.repo);

            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: sha,
                body
              });
              console.log(" Comment posted.");
            } catch (error) {
              console.log("Failed to post comment:", error);
            }


      - name: Fail if Semgrep found issues
        run: |
          issues=$(jq '.results | length' semgrep-results.json)
          echo "Semgrep found $issues issue(s)"
          [ "$issues" -eq 0 ] || { echo "Failing due to Semgrep findings"; exit 1; }

      - name: Upload Semgrep results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
