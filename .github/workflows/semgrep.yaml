name: Semgrep reusable scan

on:
  workflow_call:
    inputs:
      isRepoPublic:
        description: "Set to true if the calling repository is public"
        required: true
        type: boolean
        default: false
    secrets:
      SEMGREP_APP_TOKEN:
        required: true
      ARTIFACT_PASSWORD:
        required: false
        description: "Password for encrypting artifacts in public repos"

permissions:
  contents: read
  pull-requests: write
  security-events: write # Required to upload SARIF to GitHub

jobs:
  semgrep:
    # We stay on ubuntu-latest (VM) to ensure 'checkout' and 'upload-artifact' work reliably,
    # but we use 'docker run' for the actual scanning tool.
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR or branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Install jq and zip
        run: |
          sudo apt-get -qq update
          sudo apt-get -y install jq zip

      - name: Run Semgrep (JSON Output)
        id: run-semgrep
        env:
           # Ensure this matches your GitHub Secret Name
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          # 1. Debug check (Prints "Set" or "Empty", never the actual token)
          if [ -z "$SEMGREP_APP_TOKEN" ]; then
            echo "::error::SEMGREP_APP_TOKEN is missing from Secrets!"
            exit 1
          else
            echo "Token is set. Proceeding..."
          fi

          # 2. Run Semgrep
          docker run --rm \
            -v "$(pwd):/src" \
            -w /src \
            -e SEMGREP_APP_TOKEN="$SEMGREP_APP_TOKEN" \
            returntocorp/semgrep \
            semgrep ci --json --output semgrep-results.json || true


      # IMPROVEMENT 1: Generate SARIF (Only if repo is PRIVATE)
      - name: Generate SARIF Report
        if: inputs.isRepoPublic == false
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          docker run --rm \
            -v "$(pwd):/src" \
            -w /src \
            -e SEMGREP_APP_TOKEN="$SEMGREP_APP_TOKEN" \
            -e GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
            -e GITHUB_REF="$GITHUB_REF" \
            -e GITHUB_SHA="$GITHUB_SHA" \
            -e GITHUB_ACTOR="$GITHUB_ACTOR" \
            -e GITHUB_RUN_ID="$GITHUB_RUN_ID" \
            -e GITHUB_EVENT_NAME="$GITHUB_EVENT_NAME" \
            -e GITHUB_HEAD_REF="$GITHUB_HEAD_REF" \
            returntocorp/semgrep \
            semgrep ci --json --output semgrep-results.json || true
          
          if [ -f "semgrep.sarif" ]; then
             sudo chown -R $USER:$USER semgrep.sarif
          else
             echo "::warning::SARIF generation failed. File not created."
          fi

      # IMPROVEMENT 1: Upload SARIF to GitHub (Only if repo is PRIVATE)
      - name: Upload SARIF to GitHub Security Dashboard
        if: inputs.isRepoPublic == false && steps.run-semgrep.outputs.count != '0'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        continue-on-error: true

      - name: Comment on PR with Semgrep findings
        # Logic maintained: Only run if PR + Issues Found + Not Public
        if: github.event_name == 'pull_request' && steps.run-semgrep.outputs.count != '0' && !inputs.isRepoPublic
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('semgrep-results.json','utf8'));
            if (!results.results?.length || !context.issue?.number) return;

            const uniq = [...new Map(results.results.map(i => [
              `${i.check_id}:${i.path}:${i.start.line}`, i])).values()];

            let body = `**Semgrep found ${uniq.length} unique issue(s):**\n\n`;
            for (const i of uniq) {
              const msg = i.message || i.extra?.message || 'no description';
              body += `- \`${i.path}:${i.start.line}\` **${i.check_id}** â€“ ${msg}\n`;
            }

            const org = "excellence-cloud-gmbh";
            const repo = encodeURIComponent(`${context.repo.owner}/${context.repo.repo}`);
            const ref = encodeURIComponent(context.ref);
            const scanUrl = `https://semgrep.dev/orgs/${org}/findings?repo=${repo}&ref=${ref}`;
            const supplyChainUrl = `https://semgrep.dev/orgs/${org}/supply-chain/vulnerabilities?repo=${repo}&ref=${ref}`;

            body += `\n---\n[View findings](${scanUrl})\n[Supply chain](${supplyChainUrl})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail if Semgrep found High/Critical issues
        run: |
          # Count findings where severity is ERROR (High/Critical) or explicitly CRITICAL
          high_issues=$(jq '[.results[] | select(.extra.severity == "ERROR" or .extra.severity == "CRITICAL")] | length' semgrep-results.json)
          
          echo "Semgrep found $high_issues High/Critical issue(s)"
          
          if [ "$high_issues" -gt 0 ]; then
            echo "::error::Failing due to $high_issues High/Critical Semgrep findings."
            exit 1
          fi

      - name: Prepare Artifacts
        if: always()
        id: prepare-artifact
        env:
          IS_PUBLIC: ${{ inputs.isRepoPublic }}
          ARTIFACT_PASS: ${{ secrets.ARTIFACT_PASSWORD }}
        run: |
          if [ ! -s semgrep-results.json ]; then
             echo "::warning::semgrep-results.json is missing or empty (0 bytes). creating placeholder."
             echo '{"results": [], "error": "Scan failed to generate output"}' > semgrep-results.json
          fi

          if [ "$IS_PUBLIC" == "true" ]; then
             echo "Public repo detected. Encrypting results..."
             
             if [ -z "$ARTIFACT_PASS" ]; then
               echo "::error::Repo is public but ARTIFACT_PASSWORD secret is missing!"
               exit 1
             fi

             zip -P "$ARTIFACT_PASS" -j semgrep-results.zip semgrep-results.json
             
             if [ ! -s semgrep-results.zip ]; then
                 echo "::error::Zip creation failed! File is empty."
                 exit 1
             fi
             
             echo "artifact_path=semgrep-results.zip" >> "$GITHUB_OUTPUT"
          else
             echo "Private repo. Keeping raw JSON."
             echo "artifact_path=semgrep-results.json" >> "$GITHUB_OUTPUT"
          fi
          
          ls -lh semgrep-results*

      - name: Upload Semgrep results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-scan-findings
          path: ${{ steps.prepare-artifact.outputs.artifact_path }}
          retention-days: 5