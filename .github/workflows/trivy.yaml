# .github/workflows/trivy.yaml
name: Trivy JSON Scan

on:
  workflow_call:


permissions:
  contents: read

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    name: Trivy Security Scan
    env:
      REPO: ${{ github.repository }}
      REF: ${{ github.head_ref || github.ref_name }}

    steps:
    - name: Checkout caller repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ github.ref }}

    - name: Install Trivy via tarball
      run: |
        set -eo pipefail
        LATEST=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest \
          | jq -r .tag_name)
        curl -sSL \
          https://github.com/aquasecurity/trivy/releases/download/${LATEST}/trivy_${LATEST#v}_Linux-64bit.tar.gz \
          | sudo tar -xzC /usr/local/bin trivy
        trivy --version

    - name: Run Trivy (JSON output)
      continue-on-error: true
      run: |
        trivy fs . \
          --scanners vuln,config,secret,license \
          --format json \
          --output trivy-results.json

    - name: Trivy Security Scan Summary
      run: |
        set -eo pipefail
        echo "### ðŸ” Trivy Security Scan Summary" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "#### âš ï¸ Vulnerabilities" >> "$GITHUB_STEP_SUMMARY"
        echo '| Target | Type | Severity | Package | Installed | Fixed | Title |' >> "$GITHUB_STEP_SUMMARY"
        echo '|--------|------|----------|---------|-----------|-------|-------|' >> "$GITHUB_STEP_SUMMARY"

        jq -r '
          .Results[]?
          | select(.Vulnerabilities)
          | . as $r
          | .Vulnerabilities[]
          | {
              target:    $r.Target,
              type:      $r.Type,
              severity:  .Severity,
              pkg:       .PkgName,
              installed: .InstalledVersion,
              fixed:     (.FixedVersion // "â€”"),
              title:     (.Title | gsub("[\r\n]+";" ") | gsub("[|]";" "))
            }
          | [
              .target,
              .type,
              (if .severity=="CRITICAL" then "ðŸ›‘ CRITICAL"
               elif .severity=="HIGH"   then "ðŸ”´ HIGH"
               elif .severity=="MEDIUM" then "ðŸŸ¡ MEDIUM"
               elif .severity=="LOW"    then "ðŸŸ¢ LOW"
               else "âšª UNKNOWN" end),
              .pkg,
              .installed,
              .fixed,
              .title
            ] | @tsv' trivy-results.json |
        while IFS=$'\t' read -r target type sev pkg inst fix title; do
          clean="${target#./}"
          clean="${clean#/}"
          url="https://github.com/${REPO}/blob/${REF}/${clean}"
          echo "| [${target}](${url}) | $type | $sev | $pkg | $inst | $fix | $title |" \
            >> "$GITHUB_STEP_SUMMARY"
        done

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "#### ðŸ”§ Misconfigurations" >> "$GITHUB_STEP_SUMMARY"
        echo '| Target | Type | Severity | Title | Message | Resolution |' >> "$GITHUB_STEP_SUMMARY"
        echo '|--------|------|----------|-------|---------|------------|' >> "$GITHUB_STEP_SUMMARY"

        jq -r '
          .Results[]?
          | select(.Misconfigurations)
          | . as $r
          | .Misconfigurations[]
          | {
              target:     $r.Target,
              type:       $r.Type,
              severity:   .Severity,
              title:      (.Title     | gsub("[\r\n]+";" ") | gsub("[|]";" ")),
              message:    (.Message   | gsub("[\r\n]+";" ") | gsub("[|]";" ")),
              resolution: (.Resolution| gsub("[\r\n]+";" ") | gsub("[|]";" "))
            }
          | [
              .target,
              .type,
              (if .severity=="CRITICAL" then "ðŸ›‘ CRITICAL"
               elif .severity=="HIGH"   then "ðŸ”´ HIGH"
               elif .severity=="MEDIUM" then "ðŸŸ¡ MEDIUM"
               elif .severity=="LOW"    then "ðŸŸ¢ LOW"
               else "âšª UNKNOWN" end),
              .title,
              .message,
              .resolution
            ] | @tsv' trivy-results.json |
        while IFS=$'\t' read -r target type sev title msg res; do
          clean="${target#./}"
          clean="${clean#/}"
          url="https://github.com/${REPO}/blob/${REF}/${clean}"
          echo "| [${target}](${url}) | $type | $sev | $title | $msg | $res |" \
            >> "$GITHUB_STEP_SUMMARY"
        done

    - name: Upload Trivy JSON Report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-results-json
        path: trivy-results.json

    - name: Fail if vulnerabilities found
      run: |
        trivy fs . \
          --scanners vuln,config,secret,license \
          --exit-code 1 \
          --severity CRITICAL,HIGH \
          --no-progress
