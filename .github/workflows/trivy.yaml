name: Trivy JSON Scan

on:
  workflow_call:

permissions:
  contents: read

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    name: Trivy Security Scan

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  #  pulls the branch of the repo that triggered the reusable workflow
          ref: ${{ github.ref }}

      - name: Install Trivy 
        run: |
          sudo apt-get update
          sudo apt-get install wget curl -y
          LATEST_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep "tag_name" | cut -d '"' -f 4)
          wget -q "https://github.com/aquasecurity/trivy/releases/download/${LATEST_VERSION}/trivy_${LATEST_VERSION#v}_Linux-64bit.deb"
          sudo dpkg -i trivy_${LATEST_VERSION#v}_Linux-64bit.deb

      - name: Run Trivy (JSON output)
        continue-on-error: true
        run: |
          trivy fs . \
            --scanners vuln,config,secret,license \
            --format json \
            --output trivy-results.json

      - name: Trivy Security Scan Summary
        run: |
          ############################################################
          # Heading
          ############################################################
          echo "### ðŸ” Trivy Security Scan Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          ############################################################
          # 1. Vulnerabilities
          ############################################################
          echo "#### âš ï¸ Vulnerabilities" >> "$GITHUB_STEP_SUMMARY"
          echo '| ðŸ“„ Target | ðŸ”Ž Type | ðŸ†” CVE | ðŸ” Severity | ðŸ“¦ Package | ðŸ“Œ Installed | ðŸ› ï¸ Fixed | ðŸ§  Title |' >> "$GITHUB_STEP_SUMMARY"
          echo '|-----------|---------|--------|-------------|-----------|--------------|----------|----------|' >> "$GITHUB_STEP_SUMMARY"

          jq -r '
            .Results[]?
            | select(.Vulnerabilities)
            | . as $r
            | .Vulnerabilities[]
            | {
                target:    $r.Target,
                type:      $r.Type,
                cve:       .VulnerabilityID,
                severity:  .Severity,
                pkg:       .PkgName,
                installed: .InstalledVersion,
                fixed:     (.FixedVersion // "â€”"),
                title:     (.Title | gsub("[\\r\\n]+";" ") | gsub("\\|";" "))
              }
            | [
                .target,
                .type,
                .cve,
                (if .severity=="CRITICAL" then "ðŸ›‘ CRITICAL"
                elif .severity=="HIGH"   then "ðŸ”´ HIGH"
                elif .severity=="MEDIUM" then "ðŸŸ¡ MEDIUM"
                elif .severity=="LOW"    then "ðŸŸ¢ LOW"
                else "âšª UNKNOWN" end),
                .pkg,
                .installed,
                .fixed,
                .title
              ] | @tsv' trivy-results.json | while IFS=$'\t' read -r tgt typ cve sev pkg inst fix title; do
              echo "| $tgt | $typ | $cve | $sev | $pkg | $inst | $fix | $title |" >> "$GITHUB_STEP_SUMMARY"
            done

          ############################################################
          # 2. Misconfigurations
          ############################################################
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### ðŸ”§ Misconfigurations" >> "$GITHUB_STEP_SUMMARY"
          echo '| ðŸ“„ Target | ðŸ”Ž Type | ðŸ†” Check | ðŸ” Severity | ðŸ§  Title | ðŸ’¬ Message | ðŸ› ï¸ Resolution |' >> "$GITHUB_STEP_SUMMARY"
          echo '|-----------|---------|----------|-------------|----------|-----------|----------------|' >> "$GITHUB_STEP_SUMMARY"

          jq -r '
            .Results[]?
            | select(.Misconfigurations)
            | . as $r
            | .Misconfigurations[]
            | {
                target:     $r.Target,
                type:       $r.Type,
                id:         .ID,
                severity:   .Severity,
                title:      (.Title     | gsub("[\\r\\n]+";" ") | gsub("\\|";" ")),
                message:    (.Message   | gsub("[\\r\\n]+";" ") | gsub("\\|";" ")),
                resolution: (.Resolution| gsub("[\\r\\n]+";" ") | gsub("\\|";" "))
              }
            | [
                .target,
                .type,
                .id,
                (if .severity=="CRITICAL" then "ðŸ›‘ CRITICAL"
                elif .severity=="HIGH"   then "ðŸ”´ HIGH"
                elif .severity=="MEDIUM" then "ðŸŸ¡ MEDIUM"
                elif .severity=="LOW"    then "ðŸŸ¢ LOW"
                else "âšª UNKNOWN" end),
                .title,
                .message,
                .resolution
              ] | @tsv' trivy-results.json | while IFS=$'\t' read -r tgt typ id sev title msg res; do
              echo "| $tgt | $typ | $id | $sev | $title | $msg | $res |" >> "$GITHUB_STEP_SUMMARY"
            done





      - name: Upload Trivy JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-json
          path: trivy-results.json


      - name: Fail if vulnerabilities found
        run: |
          trivy fs . \
            --scanners vuln,config,secret,license \
            --exit-code 1 \
            --severity CRITICAL,HIGH \
            --no-progress

