name: Trivy JSON Scan

on:
  workflow_call:

permissions:
  contents: read

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    name: Trivy Security Scan

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  #  pulls the branch of the repo that triggered the reusable workflow
          ref: ${{ github.ref }}

      - name: Install Trivy 
        run: |
          sudo apt-get update
          sudo apt-get install wget curl -y
          LATEST_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep "tag_name" | cut -d '"' -f 4)
          wget -q "https://github.com/aquasecurity/trivy/releases/download/${LATEST_VERSION}/trivy_${LATEST_VERSION#v}_Linux-64bit.deb"
          sudo dpkg -i trivy_${LATEST_VERSION#v}_Linux-64bit.deb

      - name: Run Trivy (JSON output)
        continue-on-error: true
        run: |
          trivy fs . \
            --scanners vuln,config,secret,license \
            --format json \
            --output trivy-results.json

      - name: Show Trivy summary
        run: |
          echo "### âœ… Trivy Security Scan Summary" >> $GITHUB_STEP_SUMMARY

          
          jq -r '
            [
              .Results[]?.Vulnerabilities[]? | .Severity
            ] | group_by(.) | map({(.[0]): length}) | add
            | to_entries 
            | (["Severity", "Count"], ["---", "---"]) + map([.key, (.value | tostring)])
            | @tsv' trivy-results.json | column -t -s $'\t' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Add detailed info table
          jq -r '
            .Results[]?.Vulnerabilities[]? 
            | {ID, Severity, PkgName, Title}
            | (["ID", "Severity", "Package", "Title"], ["--", "--", "--", "--"]) 
              + [[.ID, .Severity, .PkgName, .Title]]
            | @tsv' trivy-results.json | column -t -s $'\t' >> $GITHUB_STEP_SUMMARY



      - name: Upload Trivy JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-json
          path: trivy-results.json